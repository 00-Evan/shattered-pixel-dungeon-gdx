diff a/core/src/com/watabou/pixeldungeon/items/Item.java b/core/src/com/watabou/pixeldungeon/items/Item.java	(rejected hunks)
@@ -205,10 +203,10 @@ public class Item implements Bundlable {
 			quantity--;
 			updateQuickslot();
 			
-			try { 
-				Item detached = getClass().newInstance();
-				detached.onDetach( );
-				return detached;
+			try {
+                Item detached = getClass().newInstance();
+                detached.onDetach( );
+                return detached;
 			} catch (Exception e) {
 				return null;
 			}
@@ -216,26 +214,28 @@ public class Item implements Bundlable {
 	}
 	
 	public final Item detachAll( Bag container ) {
-		
-		for (Item item : container.items) {
-			if (item == this) {
-				container.items.remove( this );
-				item.onDetach( );
-				QuickSlot.refresh();
-				return this;
-			} else if (item instanceof Bag) {
-				Bag bag = (Bag)item;
-				if (bag.contains( this )) {
-					return detachAll( bag );
-				}
-			}
-		}
+        for (Item item : container.items) {
+            if (item == this) {
+                container.items.remove( this );
+                item.onDetach( );
+                QuickSlot.refresh();
+                return this;
+            } else if (item instanceof Bag) {
+                Bag bag = (Bag)item;
+                if (bag.contains( this )) {
+                    return detachAll( bag );
+                }
+            }
+        }
 		
 		return this;
 	}
 	
-	protected void onDetach( ) {
+	public boolean isSimilar( Item item ) {
+		return getClass() == item.getClass();
 	}
+
+    protected void onDetach(){}
 	
 	public Item upgrade() {
 		
